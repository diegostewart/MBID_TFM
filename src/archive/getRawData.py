# Imports
from dotenv import load_dotenv
import os
import pandas as pd
from binance.client import Client
import requests
import json
import time
from datetime import datetime

# Load our secrets
load_dotenv('secrets\secrets.env')

# Initialize our client
api_key = os.getenv('API_KEY')
api_secret = os.getenv('API_SECRET')
client = Client(api_key, api_secret, testnet=True)

# Define our weight variable to control API limits
current_API_weight = 0
MAX_API_WEIGHT = 28
# MAX_API_WEIGHT = 5500


# Helper function to control API limits
def check_API_limits():
    global current_API_weight
    if current_API_weight >= MAX_API_WEIGHT:
        current_time = time.localtime()
        # seconds remaining until the end of the current minute
        seconds_left = 60 - current_time.tm_sec
        print(
            f"API limit exceeded with weight = {current_API_weight}. Waiting for {seconds_left} seconds.")
        time.sleep(seconds_left)
        current_API_weight = 0


# We should add start time and end time, and limit to 1000.
def get_klines_data(symbol, interval):
    global current_API_weight
    check_API_limits()
    url = 'https://api1.binance.com'
    api_call = '/api/v3/klines?symbol='+symbol+'&interval='+interval+'&limit=1'
    headers = {'content-type': 'application/json', 'X-MBX-APIKEY': api_key}

    response = requests.get(url + api_call, headers=headers)
    response_text = json.loads(response.text)
    current_API_weight = int(response.headers.get('x-mbx-used-weight-1m'))
    # print(response)
    # print(response.headers)
    print(response_text)


get_klines_data('BTCUSDT', '1h')

# This is the respones we recieve

# <Response [200]>
# {'Date': 'Sun, 14 Jan 2024 11:16:50 GMT', 'Content-Type': 'application/json;charset=UTF-8', 'Content-Length': '29559', 'Connection': 'keep-alive', 'Server': 'nginx', 'x-mbx-uuid': '988eb35a-e26c-45ce-9534-adc669586026', 'x-mbx-used-weight': '2', 'x-mbx-used-weight-1m': '2', 'content-encoding': 'gzip', 'Strict-Transport-Security': 'max-age=31536000; includeSubdomains', 'X-Frame-Options': 'SAMEORIGIN', 'X-Xss-Protection': '1; mode=block', 'X-Content-Type-Options': 'nosniff', 'Content-Security-Policy': "default-src 'self'", 'X-Content-Security-Policy': "default-src 'self'", 'X-WebKit-CSP': "default-src 'self'", 'Cache-Control': 'no-cache, no-store, must-revalidate', 'Pragma': 'no-cache', 'Expires': '0', 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Methods': 'GET, HEAD, OPTIONS'}
# [
# [1703433600000, '43680.23000000', '43713.86000000', '43550.00000000', '43663.10000000', '879.05159000', 1703437199999, '38360176.82016770', 61128, '412.24557000', '17988603.44138340', '0'], [1703437200000, '43663.10000000', '43710.00000000', '43599.00000000', '43627.63000000', '734.95276000', 1703440799999, '32075059.64208290', 37262, '351.20768000', '15326669.87312600', '0'], [1703440800000, '43627.62000000', '43678.00000000', '43571.54000000', '43659.64000000', '559.22299000', 1703444399999, '24398077.51827310', 30872, '276.29344000', '12054132.92832350', '0'], [1703444400000, '43659.63000000', '43677.99000000', '43561.50000000', '43618.07000000', '409.88544000', 1703447999999, '17883095.50691260', 26070, '176.01520000', '7679297.53144100', '0'],
# [1703448000000, '43618.08000000', '43618.08000000', '43426.47000000', '43499.25000000', '1076.99069000', 1703451599999,'46855504.08611160', 40083, '531.22386000', '23110243.94075380', '0'],
# [1703451600000, '43499.25000000', '43560.00000000', '43458.00000000', '43489.54000000', '971.46467000', 1703455199999, '42263340.13395740', 39127, '471.11274000', '20496480.51917370', '0'], [1703455200000, '43489.54000000', '43552.73000000', '42500.00000000', '42977.30000000', '4700.85570000', 1703458799999, '202095696.42836250', 151691, '2060.54730000', '88519678.36298440', '0'], [1703458800000, '42977.29000000', '43186.52000000', '42888.00000000', '42991.50000000', '1638.22421000', 1703462399999, '70504662.04549830', 53541, '804.21310000', '34614143.21545140', '0'], [1703462400000, '42991.50000000', '43099.70000000', '42720.43000000', '42921.66000000', '1514.37175000', 1703465999999, '64957583.43202810', 62300, '756.12985000', '32431019.25230410', '0'], [1703466000000, '42921.66000000', '43085.61000000', '42914.49000000', '43047.91000000', '915.79302000', 1703469599999, '39394976.77529020', 42323, '469.04293000', '20177837.77401680', '0'], [1703469600000, '43047.90000000', '43110.00000000', '42867.81000000', '43063.59000000', '784.99470000', 1703473199999, '33744924.64567070', 36098, '387.25999000', '16645338.20348280', '0'], [1703473200000, '43063.59000000', '43158.59000000', '43011.10000000', '43152.78000000', '653.38779000', 1703476799999, '28165414.05945200', 29913, '350.78577000', '15120181.49800910', '0'], [1703476800000, '43152.78000000', '43201.10000000', '43101.53000000', '43104.50000000', '711.05355000', 1703480399999, '30681106.30250580', 31173, '342.38249000', '14773653.96171860', '0'], [1703480400000, '43104.50000000', '43252.71000000', '43104.49000000', '43238.00000000', '639.17925000', 1703483999999, '27597655.67570720', 31537, '383.64369000', '16564337.07558640', '0'],
# ...
# [1705168800000, '42898.95000000', '42904.00000000', '42724.39000000', '42806.01000000', '738.81709000', 1705172399999, '31635305.28116730', 40195, '363.97712000', '15584722.96845230', '0'], [1705172400000, '42806.00000000', '42996.64000000', '42782.00000000', '42786.25000000', '799.84192000', 1705175999999, '34319223.33291550', 43511, '417.69561000', '17925483.10445230', '0'], [1705176000000, '42786.25000000', '42923.03000000', '42699.52000000', '42870.00000000', '872.06655000', 1705179599999, '37331057.82816110', 53534, '477.65223000', '20448393.63655550', '0'], [1705179600000, '42870.00000000', '42976.15000000', '42818.00000000', '42963.44000000', '640.52376000', 1705183199999, '27483812.10299030', 31371, '305.56798000', '13110677.59741020', '0'], [1705183200000, '42963.45000000', '43040.01000000', '42886.00000000', '42990.65000000', '613.97101000', 1705186799999, '26382997.07500110', 31874, '340.60835000', '14635080.52178520', '0'], [1705186800000, '42990.65000000', '42996.08000000', '42800.30000000', '42847.99000000', '601.05687000', 1705190399999, '25774690.94331060', 36083, '291.42975000', '12496511.50722290', '0'], [1705190400000, '42847.99000000', '42890.23000000', '42664.00000000', '42687.36000000', '927.44774000', 1705193999999, '39661504.31314440', 44075, '426.96438000', '18260097.16536230', '0'], [1705194000000, '42687.36000000', '42839.86000000', '42676.88000000', '42769.19000000', '615.79960000', 1705197599999, '26338874.81033440', 31296, '346.11636000', '14803499.63629420', '0'], [1705197600000, '42769.18000000', '42829.33000000', '42657.58000000', '42779.06000000', '520.14094000', 1705201199999, '22229649.52944010', 27779, '280.80643000', '12001460.96749350', '0'], [1705201200000, '42779.07000000', '42804.78000000', '42643.98000000', '42681.82000000', '705.78485000', 1705204799999, '30145221.25493040', 32339, '366.82390000', '15667698.64209050', '0'], [1705204800000, '42681.82000000', '42698.99000000', '42562.56000000', '42580.01000000', '691.38369000', 1705208399999, '29465662.91510420', 33626, '302.87848000', '12907926.82333810', '0'], [1705208400000, '42580.00000000', '42815.17000000', '42576.26000000', '42749.99000000', '519.82513000', 1705211999999, '22207970.22574680', 27560, '327.51019000', '13991229.63358060', '0'], [1705212000000, '42749.99000000', '42999.00000000', '42749.99000000', '42998.99000000', '864.88904000', 1705215599999, '37083739.90095340', 32842, '534.14425000', '22902699.61066170', '0'], [1705215600000, '42999.00000000', '43060.00000000', '42891.12000000', '43011.44000000', '960.65538000', 1705219199999, '41293792.74665700', 40223, '476.75396000', '20493638.77313050', '0'], [1705219200000, '43011.44000000', '43030.00000000', '42888.00000000', '42996.25000000', '569.71770000', 1705222799999, '24474138.47463810', 29785, '257.33228000', '11055593.20739990', '0'], [1705222800000, '42996.26000000', '43079.00000000', '42818.34000000', '43052.41000000', '775.89013000', 1705226399999, '33310394.71559380', 43413, '361.29923000', '15513627.58870840', '0'], [1705226400000, '43052.41000000', '43066.56000000', '42865.90000000', '42889.04000000', '668.92506000', 1705229999999, '28737570.79195380', 30834, '318.81095000', '13696458.18283470', '0'], [1705230000000, '42889.04000000', '42891.99000000', '42759.34000000', '42823.97000000', '323.22593000', 1705233599999, '13836075.26918790', 18538, '136.92461000', '5860956.57057020', '0']
# ]
